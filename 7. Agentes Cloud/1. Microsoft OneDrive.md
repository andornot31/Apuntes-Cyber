## Visión general y rutas clave

* OneDrive viene preinstalado en Windows 8+; el usuario debe **habilitarlo** iniciando sesión con su cuenta de Microsoft. Por defecto sincroniza en `%UserProfile%\OneDrive`. Si el usuario cambia la ubicación, la carpeta original queda presente (vacía).
* Confirmar si está habilitado y **dónde** está la carpeta real consultando el Registro:
  `NTUSER\Software\Microsoft\OneDrive\Accounts\Personal` (valor `UserFolder`, `cid/UserCid`, `UserEmail`, `LastSignInTime`). Si existen estos valores con datos, la cuenta está autenticada.
* Carpetas de metadatos (solo si OneDrive está habilitado):
  `"%UserProfile%\AppData\Local\Microsoft\OneDrive\settings\Personal"` y `"%UserProfile%\AppData\Local\Microsoft\OneDrive\logs\Personal"`.

## Archivos bajo demanda (Files On-Demand)

* Modelo de sincronización que ahorra espacio: **solo un subconjunto** de archivos reside localmente; el resto existen “solo en la nube”. Los elementos eliminados se mueven a la **papelera online** (distinta de la local).
* Varias apps en la nube usan **puntos de reparación NTFS** (reparse points) para simular archivos; al inspeccionar el disco pueden verse tipos de archivo “inusuales”.

## Archivos de configuración y metadatos (perfil Personal)

Ubicación: `…\OneDrive\settings\Personal`
Ficheros de interés:

* `<UserCid>.ini` — **Library** (CID y ruta de la librería), `lastRefreshTime` (epoch UTC), `requestsSent`, `BytesTransferred`. Orienta sobre **última sincronización** y actividad.
* `<UserCid>-ProfileServiceResponse.txt` (JSON) — `givenName`, `surname`, `userPrincipalName`. **Identidad** de la cuenta.
* `<UserCid>.dat` y (si existe) `<UserCid>.dat.previous` — **Listado exhaustivo** de **todos** los nombres de archivos y carpetas **locales y en la nube** (incluidos elementos **compartidos** con el usuario). Los **nombres de archivos eliminados** “envejecen” muy rápido y suelen desaparecer; `.dat.previous` puede conservar un conjunto distinto (más antiguo).

  * Análisis rápido: extraer cadenas (p. ej., con *bstrings*). Análisis estructurado: **OneDriveExplorer** (GUI/CLI) reconstruye rutas usando los UUID/GUID internos del `.dat`.

## Registros (logs) útiles

Ubicación: `…\OneDrive\logs\Personal`

* `SyncDiagnostics.log` — a veces guarda **mucho detalle** de la última “verificación de sincronización”: **ruta completa**, tamaño, `creationTime` y `modTime` (epoch UTC) por archivo, totales en nube vs local, `CID`, marcas de tiempo del reporte, y **ofuscación** parcial de nombres (ver `ObfuscationStringMap.txt`). **No siempre** aparece esta sección; el mismo log puede contener informes menos útiles (“Sync Progress”).
* `ObfuscationStringMap.txt` — tabla simple que cruza **alias ofuscados** ↔ **nombres reales**; también sirve como fuente adicional de nombres.

## OneDrive para la Empresa (OneDrive Business)

* Diferente *backend* (Microsoft 365/SharePoint), pero **mismo cliente** de escritorio. Carpeta por defecto: `%UserProfile%\OneDrive - <CompanyName>`. Metadatos en `…\settings\Business1` y logs en `…\logs\Business1`.
* Registro (Business): `NTUSER\Software\Microsoft\OneDrive\Accounts\Business1` — `UserFolder`, `UserEmail`, `UserName`, `LastSignInTime`, `ClientFirstSignInTimestamp`, `SPOResourceID` (URL de SharePoint).
* **Tenants** (carpetas compartidas de otros orígenes/SharePoint/Teams):
  `…\Accounts\Personal\Tenants` y/o `…\Accounts\Business1\Tenants` → rutas de **carpetas compartidas** que pueden quedar fuera del árbol estándar y pasarse por alto en un triaje.
* `NTUSER\Software\SyncEngines\Providers\OneDrive` — subclaves con `MountPoint` (ubicación local) y `UrlNamespace` (origen: OneDrive/SharePoint), útil para mapear **qué** se sincroniza y **dónde**.

## Auditoría en Microsoft 365 (UAL) — OneDrive Business

* **Registro de auditoría unificado (Unified Audit Log)**: \~**90 días** por defecto (exportable vía UI, PowerShell o API). Permite filtrar por usuario, rango temporal, actividad y porciones de nombres.
* Ejemplos de eventos relevantes:

  * **Archivos**: `FileAccessed`, `FileDownloaded`, `FileUploaded`, `FileModified`, `FileMoved`, `FileRenamed`, `FileDeleted`, `FileRestored`, `FileCopied`, `FilePreviewed`.
  * **Carpetas**: `FolderCreated`, `FolderDeleted`, `FolderRenamed`, `FolderCopied`, `FolderMoved`, `FolderRestored`.
  * **Compartición**: `AnonymousLinkCreated/Used`, `CompanyLinkCreated/Used`, `SecureLinkCreated/Used`, `SharingInvitationCreated`.
  * **Sincronización**: `FileSyncDownloadedFull/Partial`, `FileSyncUploadedFull/Partial`, `ManagedSyncClientAllowed`.
  * **Permisos/sitios** (SharePoint): `SiteCollectionAdminAdded`, `AddedToGroup`, `GroupRemoved/Updated`, etc.  

## Artefactos adicionales (correlación)

* **Navegador**: las URLs de OneDrive incluyen el **CID** del usuario; ayudan a relacionar actividad web con artefactos locales (p. ej., `…cid=<CID>`).
* **Artefactos Windows** (para demostrar existencia/uso de ficheros en OneDrive, también con Files On-Demand): Shadow Copies, LNK/JumpLists, MRUs de Office/Explorer, ShellBags, Prefetch, Papelera, etc.

---

## Procedimiento sugerido de análisis (checklist)

1. **Confirmar habilitación y rutas** (Personal/Business): revisar claves `Accounts\Personal` / `Accounts\Business1`, `Tenants` y `SyncEngines\Providers\OneDrive`; anotar `UserFolder`, `CID`, `UserEmail`, `SPOResourceID`, `MountPoint`.  
2. **Enumerar contenido lógico** con `<UserCid>.dat` (+ `.previous`) y, si procede, **parsear** con **OneDriveExplorer** para reconstruir rutas y **detectar compartidos**. **Advertencia**: eliminados **desaparecen pronto** del `.dat`. 
3. **Revisar logs**: `SyncDiagnostics.log` (si trae informe de verificación), `ObfuscationStringMap.txt` para desofuscación de nombres; extraer **timestamps** y **estado local/nube**. 
4. **Correlación OS**: LNK/JumpLists/MRUs, Shadow Copies (versionado local), Papelera **local** y **online**. Considerar Files On-Demand (no asumir presencia local). 
5. **En entornos Business**: extraer y **filtrar UAL** por usuario/actividad (descargas, compartición externa, sincronización, borrados/restauraciones) y por **UUIDs** si los tienes del `.dat`. 
6. **Documentar**: versiones, gaps (p. ej., ausencia de “Sync Verification”), límites de retención (90 días UAL) y hallazgos de “Tenants” fuera de la ruta estándar.  

---

## Tabla rápida “Qué buscar / Dónde / Qué aporta”

| Qué                            | Dónde                                                              | Para qué                                                                                           |
| ------------------------------ | ------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| Ruta real OneDrive + estado    | Registro: `…\Accounts\Personal` / `Business1`                      | Confirmar habilitación, carpeta raíz, email, CID, tiempos de inicio de sesión.                     |
| Carpetas compartidas (Tenants) | `…\Accounts\*\Tenants`                                             | Hallar **syncs compartidos** fuera de la ruta por defecto.                                         |
| Mapeo de puntos de montaje     | `…\SyncEngines\Providers\OneDrive`                                 | Correlacionar **MountPoint** ↔ **origen** (OneDrive/SharePoint).                                   |
| Inventario de nombres          | `settings\Personal\<CID>.dat` (+`.previous`)                       | Listar **todos** los nombres (local y nube); reconstruir con OneDriveExplorer. **Ojo eliminados**. |
| Identidad de la cuenta         | `settings\Personal\<CID>-ProfileServiceResponse.txt`               | Nombre, apellidos, UPN/correo.                                                                     |
| Última sync y actividad        | `settings\Personal\<CID>.ini`                                      | `lastRefreshTime`, `BytesTransferred`, `requestsSent`.                                             |
| Detalle por archivo            | `logs\Personal\SyncDiagnostics.log` (+ `ObfuscationStringMap.txt`) | Rutas, tamaños, **creation/mod times** (epoch UTC), estado local/nube, totales.                    |
| Auditoría 365 (Business)       | UAL (UI/PowerShell/API)                                            | Descargas/subidas, borrados, renombres, links anónimos/seguros, sincronización (90 días).          |

---

### Notas y “gotchas”

* El informe “Sync Verification” en `SyncDiagnostics.log` **no siempre** está presente; si no aparece, no esperes el listado de archivos.
* Con Files On-Demand, **no** asumir que un nombre en `.dat` existe localmente; valida con logs/artefactos OS o con UAL (Business).
* URLs del navegador con `cid` permiten correlación usuario–actividad (útil si no hay `.dat` o está incompleto).