## Generalidades

* Servicio de almacenamiento en la nube instalado por defecto en Windows 8+.
* Dos versiones:
	* **OneDrive Personal**.
	* **OneDrive para la Empresa** (vinculado a Microsoft 365/SharePoint).
* Requiere autenticación del usuario para habilitarse.

---

## Ubicación de Archivos Locales

| Versión  | Ruta por defecto                         |
| -------- | ---------------------------------------- |
| Personal | `%UserProfile%\OneDrive`                 |
| Empresa  | `%UserProfile%\OneDrive - <CompanyName>` |

---

## Claves del Registro importantes

### Personal

`HKCU\Software\Microsoft\OneDrive\Accounts\Personal`
* `UserFolder`: Ruta de la carpeta local de OneDrive.
* `UserEmail`: Correo de la cuenta de Microsoft.
* `cid` o `UserCid`: Identificador único del usuario.
* `LastSignInTime`: Última autenticación (epoch).
* `Tenants`: Carpetas compartidas desde otras cuentas/SharePoint.

### Empresa

`HKCU\Software\Microsoft\OneDrive\Accounts\Business1`
* Idéntica estructura que la personal, con campos adicionales:
	* `UserName`, `ClientFirstSignInTimestamp`, `SPOResourceID`.

### SyncEngines

`HKCU\Software\SyncEngines\Providers\OneDrive`
* Rastrea todas las carpetas sincronizadas.
	* `MountPoint`: Ruta local.
	* `UrlNamespace`: Fuente (ej. SharePoint).
	* `LastModifiedTime`: Último cambio.

---

## Carpeta de Configuración y Logs

Ruta general:
`%AppData%\Local\Microsoft\OneDrive\`

| Subcarpeta            | Propósito                                           |
| --------------------- | --------------------------------------------------- |
| `settings\Personal\`  | Archivos de configuración e inventario (Personal).  |
| `settings\Business1\` | Configuración de cuenta empresarial.                |
| `logs\Personal\`      | Información de sincronización, conflictos, errores. |
| `logs\Business1\`     | Igual que la personal, pero para empresa.           |

---

## Artefactos Clave

### 1. `<UserCid>.dat` y `.dat.previous`

* Registro de archivos sincronizados (locales y en la nube).
* Puede contener nombres de archivos antiguos.
* **Uso**: analizar con HxD, OneDriveExplorer o `bstrings`.

### 2. `<UserCid>.ini`

* Info de sincronización:
	* `Library`
	* `lastRefreshTime`
	* `bytesTransferred`
	* `requestsSent`

### 3. `<UserCid>-ProfileServiceResponse.txt` (JSON)

* Información del usuario:
	* Nombre, apellidos, correo.

### 4. `SyncDiagnostics.log`

* En ocasiones contiene:
	* Rutas completas de archivos, timestamps, tamaño.
	* Archivos locales y sólo en la nube.
	* Solo disponible en ciertos eventos (conflictos).

### 5. `ObfuscationStringMap.txt`

* Traducción de alias/nombres ofuscados ↔ nombres reales.

### 6. `healingItems.txt`

* Registros temporales sobre conflictos y errores de archivos.

---

## Archivos bajo demanda (Files On-Demand)

* Archivos parecen estar presentes, pero se descargan al acceder.
* Implementados mediante **NTFS reparse points**.
* **Investigación**:
	* Requiere examinar atributos NTFS.
	* Solo subset de archivos está realmente en disco.

---

## Auditoría y Registros (Solo Empresa)

### Registro de Auditoría Unificado (UAL - Microsoft 365)

* **Retención**: 90 días por defecto.
* **Formato**: JSON / CSV.
* **Acceso**: Web, PowerShell, API.

#### Actividades clave auditadas:

| Categoría      | Ejemplos                                                 |
| -------------- | -------------------------------------------------------- |
| Archivos       | FileAccessed, FileModified, FileDeleted, FileUploaded... |
| Carpetas       | FolderCreated, FolderDeleted, FolderRenamed...           |
| Compartición   | AnonymousLinkCreated, SecureLinkUsed...                  |
| Sincronización | FileSyncUploadedPartial/Full, DownloadedPartial/Full     |
| Permisos       | GroupAdded, SiteCollectionAdminAdded                     |

* También registra dirección IP, usuario, timestamp, nombre de archivo.

---

## Herramientas recomendadas

| Herramienta             | Función principal                                   |
| ----------------------- | --------------------------------------------------- |
| OneDriveExplorer        | Análisis estructurado de `<UserCid>.dat`, GUI y CLI |
| bstrings (E. Zimmerman) | Extraer cadenas legibles de binarios                |
| HxD                     | Exploración hexadecimal                             |
| PowerShell / Web Audit  | Consultar registros UAL                             |

---

## Consideraciones

* El archivo `<UserCid>.dat` es la fuente más confiable sobre archivos presentes.
* Los archivos eliminados se pierden rápidamente de los `.dat`.
* Carpetas "Tenants" pueden contener archivos compartidos, ¡no olvidar revisarlas!
* Archivos antiguos pueden estar accesibles en Volume Shadow Copies o `.dat.previous`.
* Auditar el registro es esencial para determinar si OneDrive está activo.
